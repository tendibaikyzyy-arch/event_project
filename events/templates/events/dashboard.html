{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>KINI √ó Yessenov ‚Äî –ö–∞–ª–µ–Ω–¥–∞—Ä—å</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<style>
  body{margin:0;font-family:"Inter",sans-serif;background:linear-gradient(120deg,#fef6ff,#e6f3ff,#fffaf2);background-size:300% 300%;animation:move 15s ease infinite}
  @keyframes move{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  .top{display:flex;justify-content:space-between;align-items:center;padding:15px 30px}
  .top img{height:45px}
  .container{display:flex;gap:20px;padding:20px}
  .sidebar{width:230px;background:#fff;border-radius:10px;padding:15px;box-shadow:0 4px 10px rgba(0,0,0,.1)}
  .sidebar a{display:block;text-decoration:none;color:#333;padding:10px;margin-bottom:8px;border-radius:8px}
  .sidebar a:hover,.sidebar a.active{background:#ffe6d9;font-weight:700}
  .sidebar button{width:100%;background:#ff7f50;color:#fff;border:0;padding:10px;border-radius:8px;cursor:pointer}
  .sidebar button:hover{background:#ff5722}
  .main{flex:1;background:#fff;border-radius:12px;padding:25px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
  h2{margin-top:0}
  .section{display:none}
  .section.active{display:block}
  /* –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–ø–∏—Å–∫–∞ */
  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
  .card{border:1px solid #eee;border-radius:12px;padding:14px}
  .muted{color:#666;font-size:14px}
  .btn{background:#ff7f50;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
</style>
</head>
<body>

<div class="top">
  <img src="{% static 'img/yessenov.png' %}" alt="Yessenov">
  <img src="{% static 'img/kini.png' %}" alt="KINI">
</div>

<div class="container">
  <div class="sidebar">
    <a href="#" class="active" data-view="calendar">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
    <a href="#" data-view="events">üìå –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a>
    <a href="#" data-view="my">‚≠ê –ú–æ–∏ —Å–æ–±—ã—Ç–∏—è</a>
    <a href="#" data-view="notif">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</a>
    <button onclick="window.location.href='/logout/'">üö™ –í—ã–π—Ç–∏</button>
  </div>

  <div class="main">
    <!-- –ö–ê–õ–ï–ù–î–ê–†–¨ -->
    <section id="calendar" class="section active">
      <div id="calendarContainer"></div>
    </section>

    <!-- –°–ü–ò–°–û–ö –ú–ï–†–û–ü–†–ò–Ø–¢–ò–ô -->
    <section id="events" class="section">
      <h2>–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h2>
      <div id="eventList" class="cards"></div>
    </section>

    <!-- –ú–û–ò –°–û–ë–´–¢–ò–Ø -->
    <section id="my" class="section">
      <h2>–ú–æ–∏ —Å–æ–±—ã—Ç–∏—è</h2>
      <div id="myEventList" class="cards"></div>
    </section>

    <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
    <section id="notif" class="section">
      <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
      <div id="notifList"></div>
    </section>
  </div>
</div>

<!-- —Å–∫—Ä—ã—Ç–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è POST /book/ —Å CSRF -->
<form id="bookForm" method="POST" style="display:none;">
  {% csrf_token %}
</form>

<script>
  // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
  document.querySelectorAll(".sidebar a[data-view]").forEach(link => {
    link.onclick = e => {
      e.preventDefault();
      document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
      link.classList.add("active");
      document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
      const id = link.dataset.view;
      document.getElementById(id).classList.add("active");
      if (id === 'events') loadEvents();
      if (id === 'my') loadMyEvents();
      if (id === 'notif') loadNotifs();
    };
  });

  // –ö–ê–õ–ï–ù–î–ê–†–¨ —Å –±—ç–∫–µ–Ω–¥–∞
  document.addEventListener('DOMContentLoaded', function() {
    const el = document.getElementById('calendarContainer');
    const calendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      locale: 'ru',
      height: 650,
      headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek' },
      events: '/events-json/',
      eventClick: function(info) {
        const start = info.event.start ? info.event.start.toLocaleString() : '';
        alert('–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ: ' + info.event.title + '\n–î–∞—Ç–∞: ' + start);
      }
    });
    calendar.render();
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
  async function loadEvents(){
    const box = document.getElementById('eventList');
    box.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    const res = await fetch('/events-json/');
    const data = await res.json();
    if(!data.length){ box.innerHTML = '<p class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.</p>'; return; }
    box.innerHTML = '';
    data.forEach(e => {
      const left = Math.max((e.capacity||0) - (e.taken||0), 0);
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h3>${e.title}</h3>
        <p class="muted">${e.description||''}</p>
        <p><b>–ö–æ–≥–¥–∞:</b> ${e.start.replace('T',' ')}</p>
        <p><b>–ì–¥–µ:</b> ${e.place||'‚Äî'}</p>
        <p><b>–ú–µ—Å—Ç:</b> ${e.capacity||'‚Äî'} ‚Ä¢ <b>–°–≤–æ–±–æ–¥–Ω–æ:</b> ${left}</p>
        <button class="btn" ${left<=0?'disabled':''} onclick="book(${e.id})">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
      `;
      box.appendChild(card);
    });
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ "–ú–æ–∏ —Å–æ–±—ã—Ç–∏—è"
  async function loadMyEvents(){
    const box = document.getElementById('myEventList');
    box.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    const res = await fetch('/my-events-json/');
    const data = await res.json();
    if(!data.length){ box.innerHTML = '<p class="muted">–í—ã –µ—â—ë –Ω–µ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.</p>'; return; }
    box.innerHTML = '';
    data.forEach(e => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h3>${e.title}</h3>
        <p><b>–î–∞—Ç–∞:</b> ${e.date} ${e.time||''}</p>
        <p><b>–ú–µ—Å—Ç–æ:</b> ${e.place||'‚Äî'}</p>
      `;
      box.appendChild(card);
    });
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  async function loadNotifs(){
    const box = document.getElementById('notifList');
    box.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    const res = await fetch('/notifications-json/');
    const data = await res.json();
    if(!data.length){ box.innerHTML = '<p class="muted">–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</p>'; return; }
    box.innerHTML = '';
    data.forEach(n => {
      const row = document.createElement('div');
      row.className = 'card';
      row.innerHTML = `<b>${n.title}</b><br><span class="muted">${n.created}</span><p>${n.body||''}</p>`;
      box.appendChild(row);
    });
  }

  // POST –∑–∞–ø–∏—Å—å –Ω–∞ —Å–æ–±—ã—Ç–∏–µ
  function book(eventId){
    const form = document.getElementById('bookForm');
    form.action = `/events/${eventId}/book/`;
    form.submit();
  }
</script>
</body>
</html>