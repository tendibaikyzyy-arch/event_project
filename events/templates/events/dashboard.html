{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>KINI √ó Yessenov ‚Äî –ö–∞–ª–µ–Ω–¥–∞—Ä—å</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<style>
  body{
    margin:0;
    font-family:"Inter",sans-serif;
    background:linear-gradient(120deg,#fef6ff,#e6f3ff,#fffaf2);
    background-size:300% 300%;
    animation:move 15s ease infinite
  }
  @keyframes move{
    0%{background-position:0% 50%}
    50%{background-position:100% 50%}
    100%{background-position:0% 50%}
  }
  .top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:15px 30px
  }
  .top img{height:45px}
  .container{
    display:flex;
    gap:20px;
    padding:20px
  }
  .sidebar{
    width:230px;
    background:#fff;
    border-radius:10px;
    padding:15px;
    box-shadow:0 4px 10px rgba(0,0,0,.1)
  }
  .sidebar a{
    display:block;
    text-decoration:none;
    color:#333;
    padding:10px;
    margin-bottom:8px;
    border-radius:8px
  }
  .sidebar a:hover,
  .sidebar a.active{
    background:#ffe6d9;
    font-weight:700
  }
  .sidebar button{
    width:100%;
    background:#ff7f50;
    color:#fff;
    border:0;
    padding:10px;
    border-radius:8px;
    cursor:pointer
  }
  .sidebar button:hover{background:#ff5722}
  .main{
    flex:1;
    background:#fff;
    border-radius:12px;
    padding:25px;
    box-shadow:0 4px 15px rgba(0,0,0,.1)
  }
  h2{margin-top:0}
  .section{display:none}
  .section.active{display:block}

  /* –∫–∞—Ä—Ç–æ—á–∫–∏ */
  .cards{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
    gap:16px
  }
  .card{
    border:1px solid #eee;
    border-radius:12px;
    padding:14px
  }
  .muted{
    color:#666;
    font-size:14px
  }
  .btn{
    background:#ff7f50;
    color:#fff;
    border:0;
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer
  }
  .btn:disabled{
    opacity:.5;
    cursor:not-allowed
  }

  /* Django messages (–æ—Å—Ç–∞–≤–ª—è–µ–º, –Ω–æ –ø—Ä—è—á–µ–º, —Ç–æ—Å—Ç—ã –±—É–¥—É—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ) */
  .messages{margin-bottom:12px}

  /* TOAST-–£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (–≤–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞) */
  .toast-container{
    position:fixed;
    right:20px;
    bottom:20px;
    z-index:9999;
  }
  .toast{
    min-width:260px;
    margin-top:10px;
    background:#333;
    color:#fff;
    padding:10px 14px;
    border-radius:8px;
    opacity:0;
    transform:translateY(10px);
    transition:opacity .4s ease, transform .4s ease;
    font-size:14px;
    box-shadow:0 4px 10px rgba(0,0,0,.2);
  }
  .toast.show{
    opacity:1;
    transform:translateY(0);
  }
  .toast-ok{background:#2e7d32;}
  .toast-err{background:#c62828;}

  /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é –¥–ª—è –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
  .sidebar a.has-new{
    position:relative;
    font-weight:700;
    background:#fff3e0;
  }
  .sidebar a.has-new::after{
    content:'';
    position:absolute;
    right:10px;
    top:50%;
    width:8px;
    height:8px;
    background:#ff4d4f;
    border-radius:50%;
    transform:translateY(-50%);
  }
</style>
</head>
<body>

<div class="top">
  <img src="{% static 'img/yessenov.png' %}" alt="Yessenov">
  <img src="{% static 'img/kini.png' %}" alt="KINI">
</div>

<div class="container">
  <div class="sidebar">
    <a href="#" class="active" data-view="calendar">üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</a>
    <a href="#" data-view="events">üìå –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</a>
    <a href="#" data-view="my">‚≠ê –ú–æ–∏ —Å–æ–±—ã—Ç–∏—è</a>
    <a href="#" data-view="notif">üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</a>

    {% if user.is_staff %}
     <a href="{% url 'reports' %}">üìä –û—Ç—á—ë—Ç—ã</a>
    {% endif %}

    <form action="{% url 'logout' %}" method="post" style="margin-top:10px">
      {% csrf_token %}
      <button type="submit">üö™ –í—ã–π—Ç–∏</button>
    </form>
  </div>

  <div class="main">
    <!-- Django messages (–ø—Ä–µ–≤—Ä–∞—Ç–∏–º –∏—Ö –≤ —Ç–æ—Å—Ç—ã –Ω–∞ JS) -->
    <div class="messages">
      {% for m in messages %}
        <div class="msg {% if m.tags == 'success' %}ok{% else %}err{% endif %}">{{ m }}</div>
      {% endfor %}
    </div>

    <!-- –ö–ê–õ–ï–ù–î–ê–†–¨ -->
    <section id="calendar" class="section active">
      <div id="calendarContainer"></div>
    </section>

    <!-- –°–ü–ò–°–û–ö –ú–ï–†–û–ü–†–ò–Ø–¢–ò–ô -->
    <section id="events" class="section">
      <h2>–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h2>
      <div id="eventList" class="cards"></div>
    </section>

    <!-- –ú–û–ò –°–û–ë–´–¢–ò–Ø -->
    <section id="my" class="section">
      <h2>–ú–æ–∏ —Å–æ–±—ã—Ç–∏—è</h2>
      <div id="myEventList" class="cards"></div>
    </section>

    <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø -->
    <section id="notif" class="section">
      <h2>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
      <div id="notifList"></div>
    </section>
  </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div id="toastContainer" class="toast-container"></div>

<!-- –°–∫—Ä—ã—Ç–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è POST –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (—Å CSRF) -->
<form id="bookForm" method="POST" style="display:none;">
  {% csrf_token %}
</form>

<script>
  // URL-–¥–∞—Ä (Django-–¥–∞–Ω)
  const URL_EVENTS_JSON    = "{% url 'events_json' %}";
  const URL_MY_EVENTS_JSON = "{% url 'my_events_json' %}";
  const URL_NOTIFS_JSON    = "{% url 'notifications_json' %}";
  // –¢—Ä—é–∫: –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ –±–∞—Ä URL-–¥—ã JS-—Ç–∞ “õ“±—Ä—É
  const URL_BOOK_TEMPLATE  = "{% url 'register_for_event' 0 %}"; // 0-–¥—ñ –∫–µ–π—ñ–Ω id-–≥–µ –∞—É—ã—Å—Ç—ã—Ä–∞–º—ã–∑

  // ---------- TOAST-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ----------
  function createToast(text, type){
    const box = document.getElementById('toastContainer');
    const el  = document.createElement('div');
    el.className = 'toast ' + (type === 'ok' ? 'toast-ok' : 'toast-err');
    el.textContent = text;
    box.appendChild(el);

    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —Å—Ä–∞–±–æ—Ç–∞–ª transition
    setTimeout(()=> el.classList.add('show'), 10);

    // –ß–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã —Å–∫—Ä—ã–≤–∞–µ–º
    setTimeout(()=>{
      el.classList.remove('show');
      setTimeout(()=> el.remove(), 400);
    }, 4000);
  }

  // –ë–µ—Ä—ë–º Django messages –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ —Ç–æ—Å—Ç—ã
  function showDjangoMessagesAsToasts(){
    const msgBox = document.querySelector('.messages');
    if(!msgBox) return;
    const msgs = msgBox.querySelectorAll('.msg');
    if(!msgs.length) return;

    msgs.forEach(m=>{
      const text = m.textContent.trim();
      if(!text) return;
      const type = m.classList.contains('ok') ? 'ok' : 'err';
      createToast(text, type);
    });

    // –°—Ç–∞—Ä—ã–π –±–ª–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å
    msgBox.style.display = 'none';
  }

  // ---------- –ë–µ–π–¥–∂ –¥–ª—è –ø—É–Ω–∫—Ç–∞ "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" ----------
  function updateNotifMenuBadge(count){
    const link = document.querySelector('.sidebar a[data-view="notif"]');
    if(!link) return;
    if(count > 0){
      link.textContent = `üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (${count})`;
      link.classList.add('has-new');
    }else{
      link.textContent = 'üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
      link.classList.remove('has-new');
    }
  }

  async function initNotifBadge(){
    try{
      const res  = await fetch(URL_NOTIFS_JSON);
      const data = await res.json();
      // –£–ø—Ä–æ—â—ë–Ω–Ω–æ —Å—á–∏—Ç–∞–µ–º: –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è = "–Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ"
      updateNotifMenuBadge(data.length);
    }catch(err){
      // —Ç–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
    }
  }

  // –º–µ–Ω—é –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
  document.querySelectorAll(".sidebar a[data-view]").forEach(link => {
    link.onclick = e => {
      e.preventDefault();
      document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
      link.classList.add("active");
      document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
      const id = link.dataset.view;
      document.getElementById(id).classList.add("active");
      if (id === 'events') loadEvents();
      if (id === 'my')     loadMyEvents();
      if (id === 'notif')  {
        loadNotifs();
        // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—à—ë–ª –≤–æ –≤–∫–ª–∞–¥–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –≤—Å—ë –ø—Ä–æ—á–∏—Ç–∞–ª
        updateNotifMenuBadge(0);
      }
    };
  });

  // –ö–ê–õ–ï–ù–î–ê–†–¨
  document.addEventListener('DOMContentLoaded', function() {
    const el = document.getElementById('calendarContainer');
    const calendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      locale: 'ru',
      height: 650,
      headerToolbar: {
        left:'prev,next today',
        center:'title',
        right:'dayGridMonth,timeGridWeek'
      },
      events: URL_EVENTS_JSON,
      eventClick: function(info) {
        const start = info.event.start ? info.event.start.toLocaleString() : '';
        alert('–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ: ' + info.event.title + '\n–î–∞—Ç–∞: ' + start);
      }
    });
    calendar.render();

    // –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ—Å—Ç—ã –ø–æ Django messages
    showDjangoMessagesAsToasts();

    // –ü–æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–π–¥–∂ –Ω–∞ "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
    initNotifBadge();
  });

  // –°–ø–∏—Å–æ–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
  async function loadEvents(){
    const box = document.getElementById('eventList');
    box.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    try{
      const res  = await fetch(URL_EVENTS_JSON);
      const data = await res.json();
      if(!data.length){
        box.innerHTML = '<p class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.</p>';
        return;
      }
      box.innerHTML = '';
      data.forEach(e => {
        const left = Math.max((e.capacity || 0) - (e.taken || 0), 0);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${e.title}</h3>
          <p class="muted">${e.description || ''}</p>
          <p><b>–ö–æ–≥–¥–∞:</b> ${(e.start || '').replace('T',' ')}</p>
          <p><b>–ì–¥–µ:</b> ${e.place || '‚Äî'}</p>
          <p><b>–ú–µ—Å—Ç:</b> ${e.capacity || '‚Äî'} ‚Ä¢ <b>–°–≤–æ–±–æ–¥–Ω–æ:</b> ${left}</p>
          <button class="btn" ${left<=0?'disabled':''} onclick="book(${e.id})">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è</button>
        `;
        box.appendChild(card);
      });
    }catch(err){
      box.innerHTML = '<p class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</p>';
    }
  }

  // –ú–æ–∏ —Å–æ–±—ã—Ç–∏—è
  async function loadMyEvents(){
    const box = document.getElementById('myEventList');
    box.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    try{
      const res  = await fetch(URL_MY_EVENTS_JSON);
      const data = await res.json();
      if(!data.length){
        box.innerHTML = '<p class="muted">–í—ã –µ—â—ë –Ω–µ –∑–∞–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.</p>';
        return;
      }
      box.innerHTML = '';
      data.forEach(e => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h3>${e.title}</h3>
          <p><b>–î–∞—Ç–∞:</b> ${e.date} ${e.time || ''}</p>
          <p><b>–ú–µ—Å—Ç–æ:</b> ${e.place || '‚Äî'}</p>
        `;
        box.appendChild(card);
      });
    }catch(err){
      box.innerHTML = '<p class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</p>';
    }
  }

  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å–ø–∏—Å–æ–∫ –≤–æ –≤–∫–ª–∞–¥–∫–µ)
  async function loadNotifs(){
    const box = document.getElementById('notifList');
    box.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    try{
      const res  = await fetch(URL_NOTIFS_JSON);
      const data = await res.json();
      if(!data.length){
        box.innerHTML = '<p class="muted">–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.</p>';
        return;
      }
      box.innerHTML = '';
      data.forEach(n => {
        const row = document.createElement('div');
        row.className = 'card';
        row.innerHTML = `
          <b>${n.title}</b><br>
          <span class="muted">${n.created}</span>
          <p>${n.body || ''}</p>
        `;
        box.appendChild(row);
      });
    }catch(err){
      box.innerHTML = '<p class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</p>';
    }
  }

  // POST –∑–∞–ø–∏—Å—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ (—á–µ—Ä–µ–∑ —Å–∫—Ä—ã—Ç—É—é —Ñ–æ—Ä–º—É, —Å CSRF)
  function book(eventId){
    const form = document.getElementById('bookForm');
    // /events/0/book/ -> /events/{id}/book/
    form.action = URL_BOOK_TEMPLATE.replace('/0/', `/${eventId}/`);
    form.submit();
  }
</script>
</body>
</html>
